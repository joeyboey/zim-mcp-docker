# Docker Compose configuration for ZIM MCP Server
# Provides both HTTP (Streamable) and SSE transports in separate containers

version: "3.8"

services:
  # ==========================================================================
  # HTTP (Streamable) Transport - Recommended for modern MCP clients
  # ==========================================================================
  zim-mcp-http:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zim-mcp-http
    ports:
      - "8000:8000"
    volumes:
      - ./zim_files:/zim_files:ro # Mount ZIM files read-only
    environment:
      # Transport configuration
      - FASTMCP_TRANSPORT=http
      - FASTMCP_HOST=0.0.0.0
      - FASTMCP_PORT=8000

      # ZIM configuration
      - ZIM_FILES_DIRECTORY=/zim_files

      # Search settings
      - MAX_SEARCH_RESULTS=100
      - SEARCH_TIMEOUT=30

      # Content settings
      - MAX_CONTENT_LENGTH=50000

      # Cache settings
      - ARCHIVE_CACHE_SIZE=10
      - SEARCH_CACHE_SIZE=1000

      # Logging
      - LOG_LEVEL=INFO
      - FASTMCP_LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # SSE Transport - For Home Assistant and legacy clients
  # ==========================================================================
  zim-mcp-sse:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zim-mcp-sse
    ports:
      - "8001:8001"
    volumes:
      - ./zim_files:/zim_files:ro # Mount ZIM files read-only
    environment:
      # Transport configuration
      - FASTMCP_TRANSPORT=sse
      - FASTMCP_HOST=0.0.0.0
      - FASTMCP_PORT=8001

      # ZIM configuration
      - ZIM_FILES_DIRECTORY=/zim_files

      # Search settings
      - MAX_SEARCH_RESULTS=100
      - SEARCH_TIMEOUT=30

      # Content settings
      - MAX_CONTENT_LENGTH=50000

      # Cache settings
      - ARCHIVE_CACHE_SIZE=10
      - SEARCH_CACHE_SIZE=1000

      # Logging
      - LOG_LEVEL=INFO
      - FASTMCP_LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
# =============================================================================
# Usage Instructions
# =============================================================================
#
# Build and start both services:
#   docker compose up --build
#
# Start only HTTP service:
#   docker compose up zim-mcp-http
#
# Start only SSE service:
#   docker compose up zim-mcp-sse
#
# View logs:
#   docker compose logs -f zim-mcp-http
#   docker compose logs -f zim-mcp-sse
#
# Stop all services:
#   docker compose down
#
# Endpoints:
#   HTTP (Streamable): http://localhost:8000/mcp/
#   SSE:               http://localhost:8001/sse
#   Health Checks:     http://localhost:8000/health
#                      http://localhost:8001/health
